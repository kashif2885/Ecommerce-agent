<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adoob Assistant</title>
  <style>
    /* â”€â”€ Reset & base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: #1e293b;
      border-bottom: 1px solid #334155;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: #22c55e;
      flex-shrink: 0;
    }
    header h1 { font-size: 16px; font-weight: 600; color: #f1f5f9; }
    header p  { font-size: 12px; color: #64748b; margin-left: 4px; }
    #newChatBtn {
      margin-left: auto;
      background: transparent;
      border: 1px solid #334155;
      color: #94a3b8;
      padding: 5px 14px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }
    #newChatBtn:hover { border-color: #64748b; color: #e2e8f0; }

    /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main { display: flex; flex: 1; overflow: hidden; }

    /* â”€â”€ Chat panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .msg {
      display: flex;
      gap: 10px;
      max-width: 82%;
    }
    .msg.user      { align-self: flex-end;   flex-direction: row-reverse; }
    .msg.assistant { align-self: flex-start; }
    .avatar {
      width: 30px; height: 30px;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px;
      flex-shrink: 0;
    }
    .msg.user .avatar      { background: #2563eb; }
    .msg.assistant .avatar { background: #7c3aed; }
    .bubble {
      padding: 10px 14px;
      border-radius: 14px;
      line-height: 1.6;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user .bubble {
      background: #2563eb; color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.assistant .bubble {
      background: #1e293b; color: #e2e8f0;
      border: 1px solid #334155;
      border-bottom-left-radius: 4px;
    }
    .msg.assistant .bubble.is-typing {
      background: transparent; border-color: transparent; padding: 10px 4px;
    }

    /* typing animation */
    .typing-dots { display: flex; gap: 4px; padding: 6px 0; }
    .typing-dots span {
      width: 6px; height: 6px;
      background: #64748b; border-radius: 50%;
      animation: bounce 1.3s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: .2s; }
    .typing-dots span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%,60%,100% { transform: translateY(0); }
      30%         { transform: translateY(-7px); }
    }

    /* â”€â”€ Input bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-bar {
      padding: 14px 18px;
      background: #1e293b;
      border-top: 1px solid #334155;
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    #msgInput {
      flex: 1;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 10px 14px;
      color: #e2e8f0;
      font-size: 14px;
      outline: none;
      resize: none;
      height: 42px;
      max-height: 120px;
      overflow-y: auto;
      transition: border-color .2s;
    }
    #msgInput:focus { border-color: #3b82f6; }
    #sendBtn {
      background: #2563eb;
      border: none; border-radius: 8px;
      padding: 0 20px; color: #fff;
      font-size: 14px; font-weight: 600;
      cursor: pointer; transition: background .2s;
      white-space: nowrap;
    }
    #sendBtn:hover    { background: #1d4ed8; }
    #sendBtn:disabled { background: #334155; cursor: not-allowed; }

    /* â”€â”€ Tool trace panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trace-panel {
      width: 360px; flex-shrink: 0;
      background: #1e293b;
      border-left: 1px solid #334155;
      display: flex; flex-direction: column;
      overflow: hidden;
    }
    .trace-header {
      padding: 12px 16px;
      font-size: 11px; font-weight: 700;
      letter-spacing: .08em; color: #64748b;
      text-transform: uppercase;
      border-bottom: 1px solid #334155;
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
    }
    #clearTraceBtn {
      background: none; border: none;
      color: #475569; font-size: 11px; cursor: pointer;
    }
    #clearTraceBtn:hover { color: #94a3b8; }
    .trace-body {
      flex: 1; overflow-y: auto;
      padding: 10px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .trace-empty {
      color: #475569; font-size: 12px;
      text-align: center; margin-top: 40px;
    }

    /* turn separator */
    .turn-sep { border-top: 1px solid #334155; margin: 6px 0 2px; }

    /* trace card */
    .tc {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 8px; overflow: hidden;
    }
    .tc-head {
      display: flex; align-items: center; gap: 7px;
      padding: 7px 10px; cursor: pointer; user-select: none;
    }
    .tc-head:hover { background: #1e293b; }
    .tc-badge {
      font-size: 10px; font-weight: 700;
      padding: 2px 7px; border-radius: 4px; flex-shrink: 0;
    }
    .badge-tool   { background: #065f46; color: #a7f3d0; }
    .badge-result { background: #581c87; color: #e9d5ff; }
    .badge-error  { background: #991b1b; color: #fecaca; }
    .tc-title {
      font-size: 12px; color: #cbd5e1; flex: 1;
      font-weight: 500; overflow: hidden;
      text-overflow: ellipsis; white-space: nowrap;
    }
    .tc-chev { color: #475569; font-size: 10px; transition: transform .2s; }
    .tc.open .tc-chev { transform: rotate(90deg); }
    .tc-body {
      display: none; padding: 8px 10px;
      border-top: 1px solid #1e293b;
      font-size: 11px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }
    .tc.open .tc-body { display: block; }
    .tc-label {
      color: #64748b; margin-bottom: 3px;
      font-size: 10px; text-transform: uppercase; letter-spacing: .05em;
    }
    .tc-val {
      background: #020617; border: 1px solid #1e293b;
      border-radius: 4px; padding: 5px 7px;
      color: #67e8f9; white-space: pre-wrap; word-break: break-word;
      max-height: 140px; overflow-y: auto; font-size: 11px; margin-bottom: 6px;
    }

    /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
  </style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="status-dot"></div>
  <h1>Adoob Assistant</h1>
  <p>Your IT Store Expert Â· ReAct Â· LangGraph Â· GPT-5.1</p>
  <a href="/products" style="margin-left:auto;margin-right:8px;font-size:12px;color:#94a3b8;text-decoration:none;padding:5px 14px;border:1px solid #334155;border-radius:6px;" onmouseover="this.style.color='#e2e8f0'" onmouseout="this.style.color='#94a3b8'">Products</a>
  <button id="newChatBtn" onclick="newChat()">+ New Chat</button>
</header>

<!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main">

  <!-- Chat panel -->
  <div class="chat-panel">
    <div class="messages" id="messages">
      <div class="msg assistant">
        <div class="avatar">ğŸ¤–</div>
        <div class="bubble">Hey there! Welcome to <b>Adoob</b> â€” Saudi Arabia's go-to IT &amp; electronics store! ğŸ–¥ï¸

I'm your Adoob Assistant. Here's what I can do for you:

ğŸ“… <b>Appointments</b> â€” book a free product demo or tech consultation
ğŸ›ï¸ <b>Products</b> â€” search, compare, and get specs on laptops, phones, gaming gear &amp; more
ğŸ“š <b>Store Info</b> â€” shipping, returns, warranties, rewards programme, and all your FAQs

What can I help you find today?</div>
      </div>
    </div>

    <div class="input-bar">
      <textarea id="msgInput" placeholder="Type a messageâ€¦ (Enter to send, Shift+Enter for newline)" rows="1"></textarea>
      <button id="sendBtn" onclick="sendMsg()">Send</button>
    </div>
  </div>

  <!-- Tool trace panel -->
  <div class="trace-panel">
    <div class="trace-header">
      <span>Tool Trace</span>
      <button id="clearTraceBtn" onclick="clearTrace()">Clear</button>
    </div>
    <div class="trace-body" id="traceBody">
      <p class="trace-empty" id="traceEmpty">Tool calls will appear here as the agent works.</p>
    </div>
  </div>
</div>

<!-- â”€â”€ Script â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<script>
  /* â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  let sessionId    = null;
  let streaming    = false;
  let streamBubble = null;
  let accumulated  = '';
  let gotTokens    = false;
  let turnCount    = 0;
  let activeToolCard = null;

  const messagesEl = document.getElementById('messages');
  const inputEl    = document.getElementById('msgInput');
  const sendBtn    = document.getElementById('sendBtn');
  const traceBody  = document.getElementById('traceBody');

  /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function esc(s) {
    if (typeof s !== 'string') s = String(s);
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;')
            .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function scrollChat() { messagesEl.scrollTop = messagesEl.scrollHeight; }

  function fmtJson(val) {
    if (typeof val === 'string') { try { val = JSON.parse(val); } catch (_) {} }
    return typeof val === 'object' ? JSON.stringify(val, null, 2) : String(val ?? '');
  }

  /* â”€â”€ Chat bubble builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function addMsg(role, html) {
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.innerHTML = `
      <div class="avatar">${role === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
      <div class="bubble">${html}</div>`;
    messagesEl.appendChild(div);
    scrollChat();
    return div.querySelector('.bubble');
  }

  function createStreamBubble() {
    const div = document.createElement('div');
    div.className = 'msg assistant';
    div.innerHTML = `
      <div class="avatar">ğŸ¤–</div>
      <div class="bubble is-typing">
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>`;
    messagesEl.appendChild(div);
    scrollChat();
    // Return a direct reference â€“ never use a fixed id which breaks on turn 2+
    return div.querySelector('.bubble');
  }

  /* â”€â”€ Trace helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function rmEmpty() {
    const el = document.getElementById('traceEmpty');
    if (el) el.remove();
  }

  function addTurnSep() {
    if (turnCount > 1) {
      const sep = document.createElement('div');
      sep.className = 'turn-sep';
      traceBody.appendChild(sep);
    }
  }

  function addTraceCard(badgeClass, title, inputData, outputData, autoExpand) {
    rmEmpty();
    const card = document.createElement('div');
    card.className = 'tc' + (autoExpand ? ' open' : '');

    const inputHtml  = inputData  != null ? `<div class="tc-label">Input</div><div class="tc-val">${esc(fmtJson(inputData))}</div>`  : '';
    const outputHtml = outputData != null ? `<div class="tc-label">Output</div><div class="tc-val">${esc(fmtJson(outputData))}</div>` : '';

    card.innerHTML = `
      <div class="tc-head" onclick="toggleCard(this)">
        <span class="tc-badge ${badgeClass}">${badgeClass.replace('badge-','').toUpperCase()}</span>
        <span class="tc-title" title="${esc(title)}">${esc(title)}</span>
        <span class="tc-chev">â–¶</span>
      </div>
      <div class="tc-body">${inputHtml}${outputHtml}</div>`;

    traceBody.appendChild(card);
    traceBody.scrollTop = traceBody.scrollHeight;
    return card;
  }

  function toggleCard(head) { head.closest('.tc').classList.toggle('open'); }

  function clearTrace() {
    traceBody.innerHTML = '<p class="trace-empty" id="traceEmpty">Tool calls will appear here as the agent works.</p>';
  }

  /* â”€â”€ Input auto-grow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
  });
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
  });

  /* â”€â”€ New chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function newChat() {
    if (sessionId) fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
    sessionId = null; turnCount = 0;
    messagesEl.innerHTML = `
      <div class="msg assistant">
        <div class="avatar">ğŸ¤–</div>
        <div class="bubble">Hey there! Welcome back to <b>Adoob</b>. How can I help you today? ğŸ–¥ï¸</div>
      </div>`;
    clearTrace();
  }

  /* â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function sendMsg() {
    const text = inputEl.value.trim();
    if (!text || streaming) return;

    streaming = true; sendBtn.disabled = true;
    inputEl.value = ''; inputEl.style.height = 'auto';
    accumulated = ''; gotTokens = false; activeToolCard = null;
    turnCount++;

    addMsg('user', esc(text));
    streamBubble = createStreamBubble();
    addTurnSep();

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text, session_id: sessionId }),
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const reader  = res.body.getReader();
      const decoder = new TextDecoder();
      let buf = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += decoder.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          try { handleEvent(JSON.parse(line.slice(6))); } catch (_) {}
        }
      }
    } catch (err) {
      if (streamBubble) {
        streamBubble.textContent = `âš  Error: ${err.message}`;
        streamBubble.style.color = '#f87171';
      }
    } finally {
      streaming = false; sendBtn.disabled = false; inputEl.focus();
    }
  }

  /* â”€â”€ SSE event handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  function handleEvent(ev) {
    switch (ev.type) {

      case 'tool_start': {
        activeToolCard = addTraceCard('badge-tool', `Tool: ${ev.tool_name}`, ev.input, null, false);
        break;
      }

      case 'tool_end': {
        if (activeToolCard) {
          const body = activeToolCard.querySelector('.tc-body');
          body.innerHTML += `<div class="tc-label">Output</div><div class="tc-val">${esc(fmtJson(ev.output))}</div>`;
          activeToolCard.classList.add('open');
          activeToolCard = null;
        } else {
          addTraceCard('badge-result', `Result: ${ev.tool_name}`, null, ev.output, false);
        }
        traceBody.scrollTop = traceBody.scrollHeight;
        break;
      }

      case 'token': {
        if (!gotTokens) {
          gotTokens = true;
          if (streamBubble) { streamBubble.classList.remove('is-typing'); streamBubble.innerHTML = ''; }
        }
        accumulated += ev.content;
        if (streamBubble) { streamBubble.textContent = accumulated; scrollChat(); }
        break;
      }

      case 'done': {
        sessionId = ev.session_id;
        if (!gotTokens && streamBubble) streamBubble.textContent = 'âœ“';
        break;
      }

      case 'error': {
        if (streamBubble) {
          streamBubble.textContent = `âš  ${ev.message}`;
          streamBubble.style.color = '#f87171';
        }
        addTraceCard('badge-error', 'Error', null, ev.message, true);
        break;
      }
    }
  }
</script>
</body>
</html>
